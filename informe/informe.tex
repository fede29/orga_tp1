\documentclass[11pt,a4paper]{article}

%Paquetes importados
\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{float}
\usepackage{listings}
\usepackage[rgb,svgnames,table]{xcolor}

\addto\captionsspanish{
	\renewcommand\tablename{Tabla}
	\renewcommand\listtablename{Lista de tablas}
	\renewcommand\lstlistingname{Código}
	\renewcommand\lstlistlistingname{Lista de código}
}

\lstset{ % Defino el formato de bloques de código fuente
	inputencoding=utf8, % Indico la codificación de los archivos de entrada
	extendedchars=true, % Extiendo los caracteres
	% Escapeo caracteres especiales
	literate={á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1 {ñ}{{\~n}}1,
	showtabs=false, % Indica si se muestran los tabs
	tabsize=2, % Indica la cantidad de espacios que ocupa un tab
	showspaces=false, % Indica si muestra los espacios
	showstringspaces=false, % Indica si muestra los espacios dentro de strings
	numbers=left, % Posición en que se muestran los números de línea
	numberstyle=\tiny\color{gray}, % Estilo de los números de línea
	breaklines=true, % Se parten las líneas que exceden del ancho del documento
	frame=single, % Formato del marco del entorno
	backgroundcolor=\color{gray!5}, % Color de fondo
	basicstyle=\ttfamily\footnotesize, % Estilo de base (familia, tamaño, color)
	keywordstyle=\color{DarkBlue}, % Estilo de las palabras reservadas
	stringstyle=\color{red}, % Estilo de los strings
	commentstyle=\color{DarkGreen}, % Estilo de los comentarios
	language=Octave, % Espeficica el lenguaje a usar
	otherkeywords={std,cout} % Agrego palabras reservadas que no se resaltan
}

\begin{document}
\title{TP Organizacion de Computadoras}
\author{Federico Rodriguez Longhi}		
\date{\today}

\begin{titlepage}
	
	\begin{figure}[H]
		\raggedright
		\includegraphics[scale=0.25]{logo_fiuba2}
		\hfill
		\raggedleft
		\includegraphics[scale=0.2]{logo_uba}
	\end{figure}
	\rule{\textwidth}{1pt}\par % Thick horizontal line
	\vspace{2pt}\vspace{-\baselineskip} % Whitespace between lines
	\rule{\textwidth}{0.4pt}\par % Thin horizontal line
	
	\vspace{0.05\textheight} % Whitespace between the top lines and title
	\centering % Center all text
	{\Huge UBA FACULTAD DE INGENIERÍA}\\[0.5\baselineskip]
	{\Large 66.20 Organización de Computadoras}\\[0.5\baselineskip]
	{\Huge Trabajo Practico}\\[0.75\baselineskip]
	{\Large 2$^{do}$ Cuatrimestre 2016}\\[0.5\baselineskip]
	\vspace{0.2\textheight}
	
	\begin{table}[H]
		\begin{flushleft}
		{\Large Grupo 1}\\
		\vspace{0.01\textheight}
		\textbf{Integrantes:}\\
		\vspace{0.01\textheight}
		\begin{tabular}{l r}
			Federico Rodriguez  & 93336\\
			\hspace{0.05\textwidth}fede.longhi@hotmail.com&\\
			Ezequiel Dufau & 91985\\
			\hspace{0.05\textwidth}fede.longhi@hotmail.com&\\
			Pablo Ascarza & 89711\\
			\hspace{0.05\textwidth}fede.longhi@hotmail.com&\\
		\end{tabular}
		\end{flushleft}
	\end{table}
	
	\vspace{0.05\textheight}
	\vspace{2pt}
	\vfill
	\rule{\textwidth}{1pt}\par % Thick horizontal line
	\vspace{2pt}\vspace{-\baselineskip} % Whitespace between lines
	\rule{\textwidth}{0.4pt}\par % Thin horizontal line
	
\end{titlepage}

\tableofcontents
\newpage

\section{Enunciado}

\section{Introducción}
El presente trabajo tiene como objetivo familiarizarse con el conjunto de instrucciones \emph{MIPS-32} y el concepto de ABI. Para el cumplimiento de este objetivo se desarrolló un programa que simula el \emph{``Juego de la Vida'' de Conway} según lo detallado en el enunciado.

La implementación se realizo en el lenguaje de programacion C. Además se desarrollo una porción en assembler \emph{MIPS-32} que luego será detallada.

El programa fue desarrollado para correr sobre una plataforma \emph{NetBSD / MIPS-32} mediante el emulador \emph{GXEmul}.



\section{Utilización}
El programa fue implementado para que cumpliera con los requisitos pedidos por el tp.
En las siguientes secciones se detallarán los diferentes aspectos para la ejecución del programa.

\subsection{Compilación y Ejecución}
\begin{enumerate}
	\item Descargar el archivo fuente ``conway.c"
	\item Compilar el archivo (por ejemplo con gcc:\\
	\texttt{gcc -Wall -c  ``conway.c''\\
	gcc -Wall -o ``conway'' ``conway.c''})
	\item Ejecutar el programa con: \texttt{./conway i M N input [-o output]}
\end{enumerate}

\subsection{Documentación de Parámetros}
\begin{itemize}
	\item \texttt{i} es la cantidad de simulaciones que queremos realizar.
	\item \texttt{M} y \texttt{N} especifican las dimensiones de la matriz sobre la cual queremos simular.
	\item \texttt{input} es el nombre del archivo que contiene las coordenadas de las celdas vivas e identifica el estado inicial de la matriz.
	\item \texttt{-o} es un parámetro opcional que especifica que se utilizará el nombre \texttt{output} como prefijo de los nombres de los archivos pbm generados. En caso de no existir este parámetro tomara como prefijo \texttt{input}.
	\item \texttt{-V} o \texttt{--version} muestra la versión del programa.
	\item \texttt{-h} o \texttt{--help} muestra la ayuda.
\end{itemize}

\subsection{Documentación de Errores}
A continuación se detallan los errores y su significado:
\begin{itemize}
	\item \textbf{Actions Count must be a positive integer:} El primer parámetro tiene que ser un entero positivo.
	\item \textbf{Number of rows must be a positive integer:} El número de filas tiene que ser un entero positivo.
	\item \textbf{Number of columns must be a positive integer:}El número de columnas tiene que ser un entero positivo.
	\item \textbf{Invalid parameter:} Para el caso de \texttt{-V}, \texttt{-h} y \texttt{-o}. El parámetro no coincide con estos valores (o sus equivalentes).
	\item \textbf{Wrong number of parameters:} Hay parámetros de mas o de menos (se pasó un número de parámetros distinto a 1 o 6).
	\item \textbf{Error while opening input file:} No se pudo abrir el archivo de entrada.
	\item \textbf{Error while opening output file: [nombre\_de\_archivo]:} No se pudo abrir el archivo de salida con el nombre \emph{nombre\_de\_archivo}
\end{itemize}

\subsection{Algunas Aclaraciones}
\begin{itemize}
	\item Las imágenes pbm generadas se guardan en la carpeta imágenes.
	\item Todos los errores se imprimen directamente a \texttt{stderr}.
	
\end{itemize}

\subsection{Ejemplos de Uso}

Para ver la documentación:\\

\texttt{./conway -h}\\

Para ver la informacion sobre la version:\\

\texttt{./conway -V}\\

Para generar un tablero de $100 \times 50$ a partir del archivo \texttt{glider} y realizar 20 iteraciones:\\

\texttt{./conway 20 100 50 glider}\\

Los archivos pbm generados por el comando anterior seran nombrados de la forma: ``glider\_N.pbm''.\\

Para generar un tablero de $20 \times 30$ a partir del archivo \texttt{pento}, realizar 10 iteraciones y que los archivos pbm generados tengan como prefijo el nombre \texttt{jorge}:\\

\texttt{./conway 10 20 30 pento -o jorge}\\

Los archivos pbm generados por el comando anterior seran nombrados de la forma: ``jorge\_N.pbm''.



\section{Implementación}
En esta sección se presentar porciones del programa. Para ver el código completo dirigirse al apéndice A.

La implementación se hizo completamente en C. Luego se programo en MIPS la función vecinos. A continuación se detallan las dos implementaciones.

\subsection{Implementación en C}

Para la implementación se diseño una función en C según la documentación del enunciado que corresponde a:\\
\texttt{unsigned int vecinos(unsigned char *a,\\
	unsigned int i, unsigned int j,\\
	unsigned int M, unsigned int N);}\\

Tenemos que considerar un detalle sobre el tratamiento de la matriz para entender el algoritmo. En la figura siguiente se muestra la conversión de la matriz a array que utilizamos.

\begin{equation*}
\begin{bmatrix}
0,0 & 0,1 & 0,2 \\
1,0 & 1,1 & 1,2 \\
2,0 & 2,1 & 2,2
\end{bmatrix}
\rightarrow 
\begin{bmatrix}
\underset{0}{0,0} & \underset{1}{0,1} & \underset{2}{0,2} & \underset{3}{1,0} & \underset{4}{1,1} & \underset{5}{1,2} & \underset{6}{2,0} & \underset{7}{2,1} & \underset{8}{2,2}
\end{bmatrix}
\end{equation*}

A continuación se muestra el algoritmo implementado en C:

\begin{lstlisting}[caption={Código de la funcion vecinos},label={lst:codigoc}]
unsigned int vecinos(unsigned char *a, unsigned int i, unsigned int j, unsigned int M, unsigned int N){
	unsigned int vecinos = 0;
	int x,y;
	for (x = -1; x<2; x++){
		for (y = -1; y<2; y++){
			if (x+i>=0 && x+i<N && y+j>=0 && y+j<M){
				if ((!(x==0&&y==0)) && a[N*(x+i) + (y+j)] == '1'){
					vecinos++;
				}
			}
		}
	}
	return vecinos;
}
\end{lstlisting}

\subsection{Implementación en MIPS}

\subsubsection{Diagrama del Stack de Vecinos}

\section{Corridas de Prueba}
Realizamos varias corridas de prueba con los archivos proporcionados (pento, glider y sapo). Mostramos a continuación algunas salidas de las corridas:

\texttt{./conway 10 10 10 glider -s}

\begin{lstlisting}
fedelonghi@fedelonghi-dell $ ./conway 5 10 10 glider -s
starting action
Simulation number: 0

..........
..........
..........
....O.....
.....O....
...OOO....
..........
..........
..........
..........
Simulation number: 1

..........
..........
..........
..........
...O.O....
....OO....
....O.....
..........
..........
..........
Simulation number: 2

..........
..........
..........
..........
.....O....
...O.O....
....OO....
..........
..........
..........
Simulation number: 3

..........
..........
..........
..........
....O.....
.....OO...
....OO....
..........
..........
..........
Simulation number: 4

..........
..........
..........
..........
.....O....
......O...
....OOO...
..........
..........
..........


\end{lstlisting}

\texttt{./test 10 10 10 glider -o archivo\_salida}

\begin{lstlisting}
fedelonghi@fedelonghi-dell $ ./test 10 10 10 glider -o archivo_salida
starting action
\end{lstlisting}

Los archivos .pbm fueron generados en el directorio imagenes.

\texttt{./test 3 10 10 sapo -s}

\begin{lstlisting}
fedelonghi@fedelonghi-dell $ ./test 3 10 10 sapo -s
starting action
Simulation number: 0

..........
..........
..........
..........
....OOO...
...OOO....
..........
..........
..........
..........
Simulation number: 1

..........
..........
..........
.....O....
...O..O...
...O..O...
....O.....
..........
..........
..........
Simulation number: 2

..........
..........
..........
..........
....OOO...
...OOO....
..........
..........
..........
..........

\end{lstlisting}



\section{Conclusiones}


\appendix
\part*{Apéndice}
\section{Código Fuente}

\begin{lstlisting}[caption={cornway.c},label={lst:codigoc}]
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <stdbool.h>

void writePBM(unsigned char** board, unsigned int dimx, unsigned int dimy, const char* fileName, unsigned int actionNumber)
{
int i, j;
int actionNumberStringLenght = 1;
if (actionNumber >= 10){
actionNumberStringLenght = 2;
}
char str[actionNumberStringLenght];
sprintf(str, "%d", actionNumber);
char newFileName[50];
newFileName[0]='\0';
strcat(newFileName,"imagenes/");
strcat(newFileName,fileName);
strcat(newFileName,"_");
strcat(newFileName,str);
strcat(newFileName,".pbm");

FILE *fp = fopen(newFileName, "wb");
if (fp==NULL){
fprintf(stderr, "Error while opening output file: %s\n",newFileName);
exit(1);
}

unsigned int amp = 1;
(void) fprintf(fp, "P4\n%d %d\n", dimy*amp, dimx*amp);
for (j = 0; j < dimy; ++j){
for (i = 0; i < dimx; ++i)
{
unsigned int x,y;
unsigned char writeValue = 0;
if ((board[i][j]) == '1'){
writeValue = 1;
}
for (x = i*amp; x < amp*(i+1); x++){
for (y = j*amp; y < amp*(j+1); y++){
fprintf(fp, "%c", writeValue);
}
}
}
}
(void) fclose(fp);
return;
}


unsigned char ** init_board(unsigned int rows, unsigned int cols){
unsigned char** board = (unsigned char**)malloc(cols*sizeof(char*));
unsigned int i,j;
for (i = 0; i<cols; i++){
board[i] = (unsigned char *) malloc(rows*sizeof(char*));
for (j = 0; j<rows; j++){
board[i][j]='0';
}
}
return board;
}


void load_board(unsigned char **board, unsigned int rows, unsigned int cols, FILE *file){
int x,y;
while (fscanf (file, "%i %i", &x, &y)!=EOF){
if (x<cols||y<rows){
board[x][y]='1';
}
}
}


int free_board (unsigned char **board, unsigned int rows, unsigned int cols){
unsigned int i;
for (i = 0; i<cols; i++){
free(board[i]);
}
free(board);
return 0;
}


void print_board(unsigned char **board, unsigned int rows, unsigned int cols){
unsigned int i,j;
for (i = 0; i<cols; i++){
for (j = 0; j<rows; j++){
if (board[i][j] == '0'){
printf(".");
}else{
printf("O");
}
}
printf("\n");
}
}

void print_board_file(unsigned char **board, unsigned int rows, unsigned int cols,int n,const char *filename){
char newFilename [50];
int numLength = 1;
if (n >= 10 && n <= 99){
numLength = 2;
}else if (n >= 100 && n <= 999){
numLength = 3;
}
char str[numLength];
sprintf(str, "%d", n);
newFilename[0] = '\0';
strcat(newFilename, "output/");
strcat(newFilename, filename);
strcat(newFilename, "_");
strcat(newFilename, str);
FILE *file = fopen(newFilename,"w+");
fprintf(file, "Simulacion N: %i\n",n);
unsigned int i,j;
for (i = 0; i<cols; i++){
for (j = 0; j<rows; j++){
if (board[i][j] == '0'){
fprintf(file,".");
}else{
fprintf(file,"O");
}
}
fprintf(file,"\n");
}
fclose(file);
}


unsigned char* board_to_array(unsigned char ** board, unsigned int rows, unsigned int cols){
unsigned char* array = (unsigned char*)malloc(sizeof(char*)*rows*cols);
int x,y;
for (x=0; x<cols; x++){
for (y=0; y<rows; y++){
unsigned int pos = cols*x+y;
array[pos]=board[x][y];
}
}
return array;
}


unsigned int vecinos(unsigned char *a, unsigned int i, unsigned int j, unsigned int M, unsigned int N){
unsigned int vecinos = 0;
int x,y;
for (x = -1; x<2; x++){
for (y = -1; y<2; y++){
if (x+i>=0 && x+i<N && y+j>=0 && y+j<M){
if ((!(x==0&&y==0)) && a[N*(x+i) + (y+j)] == '1'){
vecinos++;
}
}
}
}
return vecinos;
}


unsigned int vecinos_m(unsigned char **board, unsigned int x, unsigned int y, unsigned int rows, unsigned int cols){
unsigned int vecinos = 0;
int i,j;
for (i = -1; i<2; i++){
for (j = -1; j<2; j++){
if (x+i>=0 && x+i<cols && y+j>=0 && y+j<rows){
if ((!(i==0&&j==0)) && board[x+i][y+j] == '1'){
vecinos++;
}
}
}
}
return vecinos;
}


void copy_board(unsigned char **from, unsigned char **to, unsigned int rows, unsigned int cols){
unsigned int i,j;
for (i = 0; i<cols; i++){
for (j = 0; j<rows; j++){
to[i][j] = from[i][j];
}
}
}


void process_board(unsigned char **board, unsigned int rows, unsigned int cols, unsigned int actionCount,const char* fileName,bool screen){
printf ("starting action\n");
unsigned char **thisBoard = init_board(rows, cols);
copy_board(board,thisBoard,rows, cols);
unsigned int i,x,y;
for (i = 0; i < actionCount; i++){
unsigned char **nextBoard = init_board(rows, cols);
if (screen){
printf("Simulation number: %i\n\n", i);
print_board(thisBoard,rows,cols);
print_board_file(thisBoard,rows,cols,i,fileName);
}else{
writePBM(thisBoard, rows, cols, fileName, i);
}
for (x = 0; x < cols; x++){
for (y = 0; y < rows; y++){
unsigned char * array = board_to_array(thisBoard, rows, cols);
unsigned int neighbours = vecinos(array, x, y, rows, cols);
free(array);
//unsigned int neighbours = vecinos_m(thisBoard,x,y,rows,cols);
if (thisBoard[x][y]=='1'){
if (neighbours == 3 || neighbours == 2){nextBoard[x][y] = '1';}
}else{
if (neighbours == 3){nextBoard[x][y] = '1';}
}
}
}
copy_board(nextBoard,thisBoard,rows, cols);
free_board(nextBoard, rows, cols);
}
free_board(thisBoard, rows, cols);
}


void print_help(){
printf("Uso:\n");
printf("  conway -h\n  conway -V\n  conway i M N inputfile [-o outputprefix]\n");
printf("Opciones:\n");
printf("  -h, --help    Imprime este mensaje\n");
printf("  -V, --version Da la version del programa\n");
printf("  -o            Prefijo de los archivos de salida\n");
printf("Ejemplos: \n");
printf("  conway 10 20 20 glider -o estado\n");
printf("  Representa 10 iteraciones del Juego de la Vida en una Matriz\n");
printf("  de 20x20, con un estado inicial tomado del archivo ''glider''.\n");
printf("  Los archivos de salida se llamarán estado_n.pbm,\n");
printf("  si no se da un prefijo para el archivo de salida, \n");
printf("  el prefijo será el nombre del archivo de entrada.\n");
}


void print_version (){
printf("Conway -Game of Life- version: 1.0\n");
}


void validate_actionsCount(int actionsCount){
if (actionsCount <= 0){
fprintf(stderr, "Actions Count must be a positive integer!\n");
exit(1);
}
}


void validate_rows(int rows){
if (rows <= 0){
fprintf(stderr, "Number of rows must be a positive integer!\n");
exit(1);
}
}


void validate_cols(int cols){
if (cols <= 0){
fprintf(stderr, "Number of columns must be a positive integer!\n");
exit(1);
}
}


int main(int argc, char* argv[])
{
char const *fileName;
char const *outputFileName;
unsigned int actionsCount;
unsigned int rows;
unsigned int cols;
unsigned char **board;
bool screen = 0;
//asigno valores de parametros
if (argc == 2){
char* arg = argv[1];
if (strcmp(arg,"-h") == 0 || strcmp(arg,"--help") == 0){
print_help();
return 0;
}
else if (strcmp(arg,"-v") == 0 || strcmp(arg,"--version") == 0){
print_version();
return 0;
}
else{
fprintf(stderr,"Invalid parameter!\n");
exit(1);
}
}else if (argc != 5 && argc != 7 && argc != 6){ //ver
fprintf(stderr,"Wrong number of parameters!\n");
exit(1);
}else{
fileName = argv[4];
actionsCount = (int) atoi(argv[1]);
validate_actionsCount(actionsCount);
rows = (int) atoi(argv[2]);
validate_rows(rows);
cols = (int) atoi(argv[3]);
validate_cols(cols);
outputFileName = fileName;
if (argc == 7){
if (strcmp(argv[5],"-o") == 0){
outputFileName = argv[6];
}else{
fprintf(stderr,"Invalid parameter!\n");
exit(1);
}
}
if (argc == 6){
if (strcmp(argv[5],"-s") == 0){
screen = 1;
}else{
fprintf(stderr,"Invalid parameter!\n");
exit(1);
}
}

}

FILE* file = fopen(fileName, "r");
if (file==NULL){
fprintf(stderr, "Error while opening input file\n");
exit(1);
}

board = init_board(rows, cols);
load_board(board, rows, cols, file);
fclose(file);
process_board(board, rows, cols, actionsCount, outputFileName, screen);
free_board(board, rows, cols);

return 0;
}

\end{lstlisting}

\end{document}
